<?php 

class piContactDetails extends piCore
{
	public function __construct()
	{
		add_action('init', array($this, 'register_contact_details'));
		add_action( 'add_meta_boxes', array($this,'te_create_contact_details_settings'), 10, 2 );
		add_action('save_post', array($this, 'te_save_data'));
		add_action('admin_enqueue_scripts', array($this, 'te_enqueu_scripts'));
	}

	public function te_save_data($postID)
	{
		if (!current_user_can('edit_post', $postID) ) return;

        if ( defined( 'DOING_AUTOSAVE' ) && DOING_AUTOSAVE ) return;

        if ( !isset($_POST['post_type']) || empty($_POST['post_type']) ) return;
        
        
        if  ( $_POST['post_type'] == 'te_aboutus' ) :
        
        	$data = isset($_POST['aboutus']) ? $_POST['aboutus'] : array();

	        $data = $this->te_unslashed_before_update($data);

	        $data = json_encode($data);

	    	update_post_meta($postID, "_te_aboutus", $data);

    	endif;
	}

	public function register_aboutus()
	{
		$teContactDetails 	= 	array
								(
							        'labels'            => array('name'=>'Contact Info', 'singular_name'=>'Contact Info'),
							        'hierarchical'      => true,
							        'public'            => true,
							        'has_archive'       => false,
							        'rewrite'           => array('slug'=>'contact-details', 'with_front'=>false),
							        'supports'          => array('title'),
							        'can_export'        => true,
							        'menu_icon'         => 'dashicons-megaphone'
							    );

		register_post_type('te_contactdetails', $teContactDetail);
	}

	public function te_create_contact_details_settings()
	{
		add_meta_box
		( 
            'te-contactdetails',
            __( 'Infomation', piCore::LANG ),
            array($this, 'te_contactdetails_builder'),
            'te_contactdetails',
            'normal',
            'default'
        );
	}

	public function te_contactdetails_builder()
	{
		
		$aContactDetails = get_post_meta($post->ID, '_contact_details', true);

		$instance = isset($aContactDetails['contact_details']) ? $aContactDetails['contact_details'] : array();


		$instance = wp_parse_args($instance, array( 'info' => array(' '), 'icon'=>array('fa fa-refresh') ) );
		?>
		<div class="postbox">
		    <div class="handlediv" title="Click to toggle">
		        <br>
		    </div>
		    <h3 class="hndle">
		        <span>Contact Info</span>
		    </h3>

		    <div class="inside">
		        <div class="bt-reset">
		            <div class="container-12-fluid">
		                <div class="container-12-row">
		                    <?php
		                    foreach ($instance['info'] as $k => $v) :
		                        ?>
		                        <div class="clone-me wrap-delete large-4">

		                            <div class="panel">
		                                <div class="panel-heading">
		                                    <div class="panel-title">&nbsp;</div>
		                                    <div class="panel-options">
		                                        <a href="#" class="delele-this"><i class="fa fa-times"></i></a>
		                                    </div>
		                                </div>

		                                <div class="panel-body">
		                                    <div class="form-group">
		                                        <label class="form-label">Icon</label>
		                                        <div class="controls">
		                                            <a class="available-panel thickbox" href="#TB_inline&width=600&height=500&inlineId=table-fa">
		                                                <i class="is_icon <?php echo $instance['icon'][$k] ?>"></i>
		                                            </a>
		                                            <input type="hidden" class="is_icon service_icon" name="contact_details[icon][]" value="<?php echo esc_attr($instance['icon'][$k]) ?>"/>
		                                        </div>
		                                    </div>

		                                    <div class="form-group">
		                                        <label class="form-label">Information</label>
		                                        <div class="controls">
		                                            <textarea class="widefat service_name reset form-control" name="contact_details[info][]"> <?php echo htmlspecialchars($v)  ?></textarea>
		                                        </div>
		                                    </div>


		                                </div>
		                            </div>
		                        </div>
		                    <?php
		                    endforeach;
		                    ?>
		                    <div class="bo-add-new wo-wrapclone">
		                        <div class="">
		                            <button class="btn btn-blue aboutus wo-addmore" type="button">Add More</button>
		                        </div>
		                    </div>
		                </div>
		            </div>
		        </div>
		    </div>
		    
		</div>
		<?php 
	}
}