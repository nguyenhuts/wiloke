;(function($, window, document, undefined)
{
    "use strict";

    $.piControl = function()
    {
        this.api = wp.customize;
       
        this.doc = $(document);
        // this.accessIframe = $('iframe').contents();
        this.uploadImage  = ".upload-img",
        this.pi_media_upload();
        this.pi_toggle(); 
        this.pi_remove_img();
        this.pi_sort_section(); 
        this.pi_scroll_to();
        this.pi_wrap_block();
        this.pi_create_section();
        this.pi_edit_custom_section();
    }  
  
    $.piControl.prototype =  
    {   
        pi_media_upload: function()
        {   
            var obj = this; 
            var _self, file_frame, insertLink= "", mdGallery= "", isMultile=true, liveInsertMe=false, $getData="", $realTime="", $jsUpload = ".js_upload", $caseSpecial="", typeBefore;
            obj.doc.on("click", obj.uploadImage,function()
            {   
                _self = $(this);
                $getData = _self.data();
                // var $sliderid = _self.closest($jsPanelSetting).data("sliderid");

                if ( !_self.hasClass("multiple") )
                { 
                    isMultile = false;
                }else{
                    isMultile = true;
                }

                typeBefore = localStorage.getItem("multiple");

                if(typeof(Storage) !== "undefined") 
                {
                   localStorage.setItem("multiple", isMultile);
                }
                
                $caseSpecial = typeof $getData.special != 'undefined' ? $getData.special : '';

                /* get id of input that will insert image src or images id to */
                insertLink=_self.data("insertlink")


                if ( file_frame && ( typeBefore == isMultile ) ) 
                {
                    file_frame.open();
                    return;
                }

                /* Create the media frame */
                file_frame = wp.media.frames.file_frame = wp.media(
                {
                    title: jQuery( this ).data( 'uploader_title' ),
                    button: {
                        text: jQuery(this).data('uploader_button_title'),
                    },
                    multiple: isMultile,

                })

                /* When an image or many images is selected, run a callback */
                file_frame.on("select", function()
                {
                    var selection = file_frame.state().get('selection');

                    switch (isMultile)
                    {
                        case true:

                            var ids = [], urls = [], idsurls = [];

                            selection.map(function(attachment)
                            {
                                attachment  = attachment.toJSON();
                                ids.push(attachment.id);
                                urls.push(attachment.url);
                            });

                            var oldids = $.map(_self.siblings(insertLink).val().split(","), function(value)
                            {
                                if (value != "")
                                {
                                    return parseInt(value, 10);
                                }
                            });

                            var $imgs = "", $slider="";
                            
                            for (var j = 0; j < ids.length; j++)
                            {
                                oldids.push(ids[j]); 

                                $imgs += '<li class="attachment img-item width-300" data-id="'+ids[j]+'">';
                                    $imgs += '<img data-src="'+urls[j]+'"  src="' + urls[j] + '" />';
                                    $imgs += '<a class="pi-remove" href="#" data-id="'+ids[j]+'">';
                                        $imgs += '<span class="dashicons dashicons-no"></span>';
                                    $imgs += '</a>';
                                $imgs += '</li>';

                                $slider += '<div class="slide">';
                                    $slider += urls[j];
                                $slider += '</div>';
                            }

                           
                            _self.siblings(insertLink).val(oldids);
                           
                            _self.siblings(".image-wrap").append($imgs);

                            if ( _self.hasClass("img_slider") )
                            {
                                obj.pi_hack_trigger("img_slider", obj);
                            }
                            

                            break;

                        case false:
                                var insert_link, origionUrl, getId;
                                selection.map(function(attachment)
                                {
                                    attachment  = attachment.toJSON();
                                    
                                    getId       =  attachment.id;
                                    insert_link  = attachment.url;
                                });

                                var $imgs="";
                                $imgs += '<li class="attachment">';
                                    $imgs += '<img data-src="'+insert_link+'"  src="' + insert_link + '" />';
                                    $imgs += '<a class="pi-remove" href="#">';
                                        $imgs += '<span class="dashicons dashicons-no"></span>';
                                    $imgs += '</a>';
                                $imgs += '</li>';

                                _self.siblings(".image-wrap").html($imgs);

                                if ( _self.hasClass("section_bg") )
                                { 
                                    _self.siblings(insertLink).val("");
                                    _self.siblings(insertLink).trigger("keypress");
                                    _self.siblings(insertLink).val(insert_link);
                                    _self.siblings(insertLink).trigger("change");
                                }else if(_self.hasClass("image_fixed")){
                                    _self.siblings(insertLink).val(insert_link);
                                    obj.pi_hack_trigger("image_fixed", obj);
                                }else if (  _self.hasClass("is_logo") )
                                {
                                    _self.siblings(insertLink).trigger("keypress");
                                    _self.next().val(insert_link);
                                    _self.siblings(insertLink).trigger("change");
                                }
                                
                            break;
                    }
                   
                })
    
                /* Finally,  open the modal */
                file_frame.open();
                return false;
            });
        },
        pi_toggle: function()
        {
            var obj = this;
            var $oSections = {'aboutus':'title_about', 'skills':'skills', 'team':'team', 'services':'services', 'portfolio':'portfolio', 'clients':'partners', 'blog': 'belowcontent', 'contact':'map_wrap'};

            var $oSectionsBg = ["aboutus", "portfolio", "team", "services", "pricingtable", "contact", "twitter", "testimonial", "ourfacts"];

            $("#customize-control-pi_save_theme_options-theme_options-header-hack_youtube input, customize-control-pi_save_theme_options-theme_options-header-hack_img_slider, customize-control-pi_save_theme_options-theme_options-header-hack_tunna_slider, customize-control-pi_save_theme_options-theme_options-header-hack_imagefixed").val("");


            /*toggle display section*/
            var _oStatus = {};
            var $sectionStatus = $("#customize-control-pi_save_theme_options-theme_options-section-status input");
            var _total = $oSections.length;
            $.each($oSectionsBg, function(i, val)
            {
                _oStatus[val] = $("pi_save_theme_options[theme_options]["+val+"][enable]").is(":checked") ? 1 : 0;
                
                if ( i == _total - 1 )
                {
                    _oStatus['contact_form'] = $("#customize-control-pi_save_theme_options-theme_options-contact-contact_form input").is(":checked") ?  1 : 0;
                    _oStatus['enablegooglemap'] = $("#customize-control-pi_save_theme_options-theme_options-contact-enablegooglemap input").is(":checked") ?  1 : 0;
                    $sectionStatus.trigger("change");
                    $sectionStatus.val( encodeURIComponent(jso.stringify(_total)) );
                    $sectionStatus.trigger("change");
                }
            })


            /*Custom Color*/
            $("#customize-control-pi_save_theme_options-theme_options-customcolor-enable input").change(function()
            {
                var $getColor = "";
                var $hackCustomColor = $("#customize-control-pi_save_theme_options-theme_options-hack_custom_color input");
                if ( $(this).is(":checked") )
                {   
                    $getColor = $("#customize-control-pi_save_theme_options-theme_options-pi_custom_color").find(".wp-color-result").css("background-color");
                    $hackCustomColor.trigger("change");
                    $hackCustomColor.val($getColor);
                    $hackCustomColor.trigger("change");
                }
            })

            /*Section Background*/
            var $bgType = "", _oData={}, $img;
            $.each($oSectionsBg, function(i, val)
            {

                $("#customize-control-pi_save_theme_options-theme_options-"+val+"-background select").change(function()
                {
                    $bgType = $(this).find("option:selected").val();  

                    if ( $bgType == 'image' )
                    {
                        $("#customize-control-pi_save_theme_options-theme_options-"+val+"-bg_img").fadeIn();
                        $("#customize-control-pi_save_theme_options-theme_options-"+val+"-bg_color").fadeOut();
                        $("#customize-control-pi_save_theme_options-theme_options-"+val+"-overlay").fadeIn();
                    }else if ( $bgType == 'color' )
                    {
                        $("#customize-control-pi_save_theme_options-theme_options-"+val+"-bg_img").fadeOut();
                        $("#customize-control-pi_save_theme_options-theme_options-"+val+"-overlay").fadeOut();
                        $("#customize-control-pi_save_theme_options-theme_options-"+val+"-bg_color").fadeIn();
                    }else{
                        $("#customize-control-pi_save_theme_options-theme_options-"+val+"-bg_img").fadeOut();
                        $("#customize-control-pi_save_theme_options-theme_options-"+val+"-overlay").fadeOut();
                        $("#customize-control-pi_save_theme_options-theme_options-"+val+"-bg_color").fadeOut();
                    }
                }).trigger("change");
                
                
               
                   
              
                $("#customize-control-pi_save_theme_options-theme_options-"+val+"-background select").change(function()
                {
                    $("#customize-control-pi_save_theme_options-theme_options-"+val+"-hack_section_bg input").val("");

                    $bgType = $(this).find("option:selected").val();

                    obj.pi_hack_section_bg(val, $bgType);
                });
            })

            /*Image For Mobile*/

            $("#customize-control-pi_save_theme_options-theme_options-video_options-videoplaceholder input").change(function()
            {
                if ( $(this).is(":checked") )
                {
                    $("#customize-control-pi_save_theme_options-theme_options-video_options-imageplaceholder").fadeIn();
                }else{
                    $("#customize-control-pi_save_theme_options-theme_options-video_options-imageplaceholder").fadeOut();
                }
            });

            // bg type
            $("#customize-control-pi_save_theme_options-theme_options-header-type select").change(function()
            {
                var getVal = $(this).find("option:selected").val();
               
                switch ( getVal )
                {
                    case 'youtube_bg':
                        $("[id*='img_slider'], [id*='tunna_slider'], [id*='text_slider'], [id*='image_fixed']").fadeOut();
                        $("[id*='youtube'], [id*='video_options'],[id*='header-title'], [id*='header-description']").fadeIn();
                        obj.pi_hack_trigger("youtube_bg", obj);
                    break;

                    case 'img_slider':
                       $("[id*='youtube'], [id*='tunna_slider'], [id*='text_slider'], [id*='image_fixed'], [id*='video_options']").fadeOut();
                       $("[id*='img_slider'],[id*='header-title'], [id*='header-description']").fadeIn();
                        obj.pi_hack_trigger("img_slider", obj);
                    break;
 
                    case 'bg_slideshow':
                        $("[id*='img_slider'], [id*='youtube'], [id*='text_slider'], [id*='image_fixed'], [id*='video_options'],[id*='header-title'], [id*='header-description']").fadeOut();
                        $("[id*='tunna_slider']").fadeIn();
                    break;

                    case 'text_slider':
                        $("[id*='img_slider'], [id*='tunna_slider'], [id*='youtube'], [id*='image_fixed'], [id*='video_options'],[id*='header-title'], [id*='header-description']").fadeOut();
                        $("[id*='text_slider']").fadeIn();
                        obj.pi_hack_trigger("text_slider", obj);
                    break;

                    case 'image_fixed':
                        $("[id*='img_slider'], [id*='youtube'], [id*='text_slider'], [id*='tunna_slider'], [id*='video_options']").fadeOut();
                        $("[id*='image_fixed'], [id*='header-title'], [id*='header-description']").fadeIn();
                        obj.pi_hack_trigger("image_fixed", obj);
                    break;
                }
            });

            $("#customize-control-pi_save_theme_options-theme_options-logo-type select").change(function()
            {
                var getVal = $(this).find("option:selected").val();
               
                switch ( getVal )
                {
                    case 'text':
                        $("[id*='logo-logo_nav'], [id*='logo-s_logo']").fadeOut();
                        $("[id*='logo-text'], [id*='logo_color']").fadeIn();
                    break;

                    case 'upload':
                        $("[id*='logo-logo_nav'], [id*='logo-s_logo']").fadeIn();
                        $("[id*='logo-text'], [id*='logo_color']").fadeOut();
                    break;
                }
            }).trigger("change"); 
            
            var $current = $("#customize-control-pi_save_theme_options-theme_options-header-type select").find("option:selected").val();

            switch ($current)
            {
                case 'youtube_bg':
                    $("[id*='img_slider'], [id*='tunna_slider'], [id*='text_slider'], [id*='image_fixed']").fadeOut();
                    $("[id*='youtube'], [id*='video_options'],  [id*='header-title']").fadeIn();
                break;

                case 'img_slider':
                   $("[id*='youtube'], [id*='tunna_slider'], [id*='text_slider'], [id*='image_fixed'], [id*='video_options']").fadeOut();
                   $("[id*='img_slider'],[id*='header-title']").fadeIn();
                   
                break;

                case 'bg_slideshow':
                    $("[id*='img_slider'], [id*='youtube'], [id*='text_slider'], [id*='image_fixed'], [id*='video_options'],[id*='header-title']").fadeOut();
                    $("[id*='tunna_slider']").fadeIn();
                break;

                case 'text_slider':
                    $("[id*='img_slider'], [id*='tunna_slider'], [id*='youtube'], [id*='image_fixed'], [id*='video_options'],  [id*='header-title']").fadeOut();
                    $("[id*='text_slider']").fadeIn();
                   
                break;

                default:
                    $("[id*='img_slider'], [id*='youtube'], [id*='text_slider'], [id*='tunna_slider'], [id*='video_options']").fadeOut();
                    $("[id*='image_fixed'], [id*='header-title']").fadeIn();
                break;
            }
            
            var $hackLogo = $("#customize-control-pi_save_theme_options-theme_options-logo-hack_logo input");
                $hackLogo.val("");
            $("#customize-control-pi_save_theme_options-theme_options-logo-type select").change(function()
            {
                var $select =  $(this).find("option:selected").val();

                if ( $select == 'upload' )
                {
                    $("#customize-control-pi_save_theme_options-theme_options-logo-text, #customize-control-pi_save_theme_options-theme_options-logo-logo_color ").fadeOut();
                    $("#customize-control-pi_save_theme_options-theme_options-logo-upload").fadeIn();
                }else{
                    $("#customize-control-pi_save_theme_options-theme_options-logo-text, #customize-control-pi_save_theme_options-theme_options-logo-logo_color ").fadeIn();
                    $("#customize-control-pi_save_theme_options-theme_options-logo-upload").fadeOut();
                }

                obj.pi_trigger_logo($hackLogo, $select);
            });
        },

        pi_trigger_logo: function($hackLogo, $selected)
        {
           var _oData = {};

            switch ($selected)
            {
                case 'upload':
                _oData['image'] = $("#customize-control-pi_save_theme_options-theme_options-logo-upload .wo-insert-link").val() ? $("#customize-control-pi_save_theme_options-theme_options-logo-upload .wo-insert-link").val() : 'http://placehold/130x130';
                _oData['type']  = 'image';
                break;
                default:
                 _oData['text'] = $("#customize-control-pi_save_theme_options-theme_options-logo-text input").val() ? $("#customize-control-pi_save_theme_options-theme_options-logo-text input").val() : 'Logo';
                _oData['type']  = 'text';
                _oData['text_color'] = $("#customize-control-pi_save_theme_options-theme_options-logo-logo_color .wp-color-result").css("background-color");
                break;
            }
            $hackLogo.trigger("change");
            $hackLogo.val( encodeURIComponent( JSON.stringify(_oData) ) );
            $hackLogo.trigger("change");
            $hackLogo.val("");
        },

        pi_hack_section_bg: function(val, $bgType)
        {
            var _oData = {},
                $img ="",
                $hack       = $("#customize-control-pi_save_theme_options-theme_options-"+val+"-hack_section_bg input"),
                $attachment = $("#customize-control-pi_save_theme_options-theme_options-"+val+"-bg_img .attachment"),
                $overlay    = $("#customize-control-pi_save_theme_options-theme_options-"+val+"-overlay input"),
                $color      = $("#customize-control-pi_save_theme_options-theme_options-"+val+"-bg_color a.wp-color-result");

            if ( $bgType == 'image' )
            {
                if ( $attachment.length > 0 )
                {
                    $img = $attachment.children().data("src");
                }else{
                    $img = "http://placehold.it/1600x1160";
                }
                _oData['image'] = $img;

                _oData['overlay'] = $overlay.is(":checked") ? 1 : 0;
                _oData['type']  = 'image';
            }else if ( $bgType == 'color' )
            {
                _oData['color'] = $color.css("background-color");
                _oData['type']  = 'color';
            }else{
                _oData['type']  = 'none';
            }
            
            $hack.trigger("change");
            $hack.val( encodeURIComponent(JSON.stringify(_oData)) );
            $hack.trigger("change");
            $hack.val("");
            _oData = {};
        },

        pi_hack_trigger: function(target, obj)
        {

            var youtubeTarget = $('#customize-control-pi_save_theme_options-theme_options-header-hack_youtube input'),
                imgsTarget = $('#customize-control-pi_save_theme_options-theme_options-header-hack_img_slider input'),
                imgFixed = $('#customize-control-pi_save_theme_options-theme_options-header-hack_imagefixed input');
            
            var _oData = {};
            
            _oData['title']  = $("#customize-control-pi_save_theme_options-theme_options-header-title input").val();
            _oData['description']  = $("#customize-control-pi_save_theme_options-theme_options-header-description textarea").val();
            
            switch ( target )
            {
                case 'youtube_bg':
                    _oData['link'] = $("#customize-control-pi_save_theme_options-theme_options-header-youtube_link input").val();
                    _oData['mute'] = $("#customize-control-pi_save_theme_options-theme_options-video_options-mute input").is(":checked")  ? 1 : 0;
                    _oData['videoplaceholder'] =  $("#customize-control-pi_save_theme_options-theme_options-video_options-videoplaceholder input").is(":checked")  ? 1 : 0;
                    _oData['quanlity'] =  $("#customize-control-pi_save_theme_options-theme_options-video_options-quality select").find("option:selected").val();

                    youtubeTarget.trigger("change");
                    youtubeTarget.val( encodeURIComponent(JSON.stringify(_oData)) );
                    youtubeTarget.trigger("change");
                    console.log(_oData);                    
                    imgsTarget.val("");
                    imgFixed.val("");
                break;

                case 'img_slider':
                    var $attachments = $("#customize-control-pi_save_theme_options-theme_options-header-img_slider .attachment"), imgs="";
                    if ( $attachments.length > 0 )
                    {
                       $attachments.each(function()
                       {
                            imgs += $(this).children().attr("data-src") + ",";
                       })
                       imgs = imgs.trim(",");
                    }else{
                        imgs = "http://placehold.it/1600x1160, http://placehold.it/1600x1160";
                    }
                    _oData['images']    = imgs;

                    imgsTarget.trigger("change");
                    imgsTarget.val( encodeURIComponent(JSON.stringify(_oData)) );
                    imgsTarget.trigger("change");

                    youtubeTarget.val("");
                    imgFixed.val("");
                break; 

                case 'image_fixed':
                    var $attachment = $("#customize-control-pi_save_theme_options-theme_options-header-image_fixed .attachment"), img="";
                    if ( $attachment.length > 0 )
                    {
                       
                        img = $attachment.children().data("src");
                      
                    }else{
                        img = "http://placehold.it/1600x1160";
                    }
                    _oData['image']    = img;
                    imgFixed.trigger("change");
                    imgFixed.val( encodeURIComponent(JSON.stringify(_oData)) );
                    imgFixed.trigger("change");

                    youtubeTarget.val("");
                    imgsTarget.val("");
                break;

                default:
                    youtubeTarget.val("");
                    imgFixed.val("");
                    imgsTarget.val("");
                break;
            }

            target = "";
        },

        pi_wrap_block: function()
        {
            $("#accordion-section-pi_section_builder .customize-control-pi-title").click(function()
            {
                $(this).nextUntil(".customize-control-pi-title").toggleClass("hidden");
                $(".customize-control-pi-add-new").removeClass("hidden"); 
            }).trigger("click");


        },

        pi_remove_img: function()
        {
            $(document).on("click", ".pi-remove", function(e)
            {
                e.preventDefault();
                var getVal = $(this).closest(".image-wrap").siblings(".wo-insert-link");
                getVal.trigger("keydown");
                var index = $(this).data("id"),
                oldids = $.map(getVal.val().split(','), function(value)
                 {
                    if (value != "")
                        return parseInt(value);
                 });

                if (oldids.length > 1)
                {
                  oldids = $.teThemes.pi_removeId(oldids, index);
                  getVal.val(oldids.join(","));
                }else{
                  getVal.val("");
                }
                
                if ($(this).parent().length > 0)
                {
                   $(this).parent().fadeOut('slow', function() 
                   {
                      $(this).remove();
                   });
                }

                getVal.trigger("change");

            })
        },

        pi_update_section_builder: function(val)
        {
            var $sectionBuilder = $("#customize-control-pi_save_theme_options-theme_options-section_builder .section-order");

            $sectionBuilder.trigger("keydown");
            $sectionBuilder.val("");
            $sectionBuilder.val(val);
            $sectionBuilder.trigger("change");
        },

        pi_sort_section: function()
        {
            
            $(".js_section_order").sortable(
            {
                update: function(event, ui) 
                {
                    var order = [];
                    var $currentParent = "#" + ui.item.parent().attr("id");
                    var $insertTo = $($currentParent).siblings(".section-order");

                    $($currentParent+' li').each( function(e) 
                    {
                        order.push( $(this).attr('data-name') );
                    });
                    // join the array as single variable...
                    var positions = order.join(',');
                    $insertTo.trigger("keydown");
                    $insertTo.val("");
                    $insertTo.val( positions );
                    $insertTo.trigger( "change" );
                    return true;
                }
            })

            $( ".js_section_order" ).disableSelection();
            
        },
        pi_scroll_to: function(){
            var $getId="", $connect = $("iframe").contents(), $offsetX=0;
            $(".customize-control-pi-title").click(function()
            {
                $getId = $(this).children().data("scrollto");

                if ( $getId != '' )
                {

                    if ( $("iframe").contents().find($getId).length > 0 )
                    {
                        $offsetX = $("iframe").contents().find($getId).offset().top;
                      
                        $("iframe").contents().scrollTop($offsetX);
                    }
                }

            })
        },
        pi_create_section: function()
        {
            $("#pi-create-section").click(function()
            { 
                var _oData = {}, _jsonData="";
                if ( $("#pi-id").val() == '' )
                {
                    alert("Please enter id");
                }else{
                    _oData.enable       = $("#pi-enable-section").val() !='' ? 1 : 0;
                    _oData.name           = $("#pi-id").val();
                    _oData.title        = $("#pi-title").val();
                    _oData.sub_title    = $("#pi-sub-title").val();
                    _oData.description  = $("#pi-description").val();
                    _oData.content      = tinyMCE.get('pi_custom_section_content').getContent();
                    
                    // convert to json
                    _jsonData = JSON.stringify(_oData);

                    $.ajax(
                    {
                        type: "POST",
                        url: ajaxurl,
                        data: {action: 'create_section', data: _jsonData},
                        success: function(res)
                        {
                            if ( res=='done' )
                            {
                                location.reload();
                            }
                        }
                    })
                }
                return false;
            })

            $("#pi-cancel").click(function()
            {
                $(".pi-wrap-editor").parent().addClass("hidden");
                $(".back-drop").remove();
                return false;
            })
        },
        pi_edit_custom_section: function()
        {
            var sectionid = "";
            $(".pi-edit-custom-section").click(function()
            {
                sectionid = $(this).data("sectionid");
                $.ajax(
                {
                    type: "POST",
                    url: ajaxurl,
                    data: {action: "edit_custom_section", sectionid: sectionid},
                    success: function(res)
                    {
                        if ( !res.enable )
                        {
                            $("#pi-enable-section").attr("checked", "");
                        }
                        $("#pi-id").val(sectionid);
                        $("#pi-title").val(res.title);
                        $("#pi-sub-title").val(res.sub_title);
                        $("#pi-description").val(res.description);
                        tinyMCE.get('pi_custom_section_content').setContent(res.content);
                    }
                })
                return false;
            })
        }
    }

    $(window).load(function()
    {
        var piControl = new $.piControl(); 

    })

})(jQuery, window, document);