<?php

if ( !class_exists('piCore') ) 
{
	class piCore
	{	 
		const LANG = 'wiloke';   
		const VERSION = '1.0';
		// const pi_ADMIN_ 
		public static $piaConfigs;
		public static $menuSlug = 'hercules-menu'; // of theme options

		private $_piaEnableModules = array("aboutme"=>0, "ourclients"=>1, "expertise"=>0, "ourteam"=>1, "portfolio"=>1, "skills"=>1, "posts"=>0, "aboutus"=>1, "experience"=>0, 'services'=>1, "avatar"=>1);

		public function __construct($piaConfigs)
		{
			self::$piaConfigs = $piaConfigs; 
			   
			add_action('admin_enqueue_scripts', array($this, "pi_admin_enqueue_scripts"));
			$this->pi_modules_init();
			add_action('wp_ajax_hello_ajax', array($this, "pi_ajax_machine"));
			add_action('wp_enqueue_scripts', array($this, "pi_enqueue_scripts"));		
			add_action('admin_footer', array($this, 'pi_include_fontawesome'));
			add_action('admin_init', array($this, 'pi_set_blog_page'));
			add_filter('pi_is_section_enable', array($this,'pi_is_section_enable'), 20, 1);
			add_filter('pi_the_heading', array($this,'pi_the_heading'), 10, 2);
			add_filter('pi_the_description', array($this,'pi_the_description'), 10, 2);
			add_filter('pi_get_data', array($this,'pi_get_data'), 10, 1);
			add_filter('pi_get_cat', array($this, 'pi_get_cat'), 10, 1);
			add_filter('pi_get_contactform', array($this, 'pi_get_contactform'), 10, 1);
			add_filter('pi_get_background', array($this, 'pi_get_background'), 10, 1 );

			add_action('wp_ajax_handle_tweet', array($this, 'pi_handle_tweet'));
			add_action('wp_ajax_nopriv_handle_tweet', array($this, 'pi_handle_tweet'));
		}  
 		// page_template	 

		public function pi_set_blog_page()
		{
			$getPages =  get_pages( array('post_type'=>'page') );
				
			$hasPageTemplate = false;

			if ( $getPages )
			{
				foreach ( $getPages as $page ) : setup_postdata($page);
					$templatePage =  get_post_meta( $page->ID, '_wp_page_template', true );
					if ( $templatePage && $templatePage == 'template-blog.php' )
					{
						$hasPageTemplate = true;
						update_option("_pi_page_id", $page->ID);
						break;
					}
				endforeach;wp_reset_postdata();
			}

			if ( !$hasPageTemplate  )
			{
				$reId = wp_insert_post( array('ID'=>'', 'post_name'=>'', 'post_title'=>'Blog', 'post_type'=>'page', 'page_template'=>'template-blog.php', 'post_status'=>'publish') );
				update_option('_pi_page_id', $reId);
			}
		}

		public function pi_is_ie9()
		{
			if(preg_match('/(?i)msie [1-9]/',$_SERVER['HTTP_USER_AGENT']))
			{
			   return true;
			}
			return false;
		}

		public function pi_include_fontawesome()
		{
			global $typenow;
			
			if ( $typenow == 'pi_expertise' || $typenow == 'pi_services' || $typenow == 'pi_funfacts')
			{
				include ( get_template_directory() . '/admin/pi-modules/table-fa.php' );
			}
		}
 		
		/**
		 * Get shortcode of contact form 7
		 */
		public function pi_get_contactform($id)
		{
			$getID = false;
			if ( has_action('customize_controls_init') )
			{
				if ( isset($_POST['customized']) )
				{
					$parseData = json_decode(wp_unslash( $_POST['customized'] ), true);
					$getID     = isset($parseData['pi_save_theme_options[theme_options][contact][contactform7_shortcode]']) && !empty($parseData['pi_save_theme_options[theme_options][contact][contactform7_shortcode]']) ? $parseData['pi_save_theme_options[theme_options][contact][contactform7_shortcode]'] : false;
				}
			}else{
					$getID     		= isset(piThemeOptions::$piOptions['contact']['contactform7_shortcode']) && !empty(piThemeOptions::$piOptions['contact']['contactform7_shortcode'])  ? piThemeOptions::$piOptions['contact']['contactform7_shortcode'] : false;
			}

			if ( $getID )
			{
			  	$piContactFormTitle = get_the_title($getID);
			  	echo do_shortcode(sprintf( '[contact-form-7 id="%1$d" title="%2$s"]', $getID, $piContactFormTitle )); 
			}else{
				echo "<p>To use contact form, you need Contact form 7 installed. If Contact form 7 is already, please go to Contact (from admin sidebar) and then create  contact form</p>";
			}
		}

		/*
		*--------------------------
			Get cat
		*--------------------------
		*/ 
		public function pi_get_cat($cat)
		{	
			$taxonomies = array($cat);
			$terms 		= get_terms($taxonomies);

			return $terms;
		}

		/*
		*--------------------------
			Section background
		*--------------------------
		*/
		public function pi_get_background($section)
		{	

			$bgType =""; $getImage=""; $getColor="";
			
			if ( isset(piThemeOptions::$piOptions[$section]['background']) && !empty(piThemeOptions::$piOptions[$section]['background']) )
			{

				$bgType =  piThemeOptions::$piOptions[$section]['background'];

				if ( $bgType == 'image' )
				{
					$getImage =  isset(piThemeOptions::$piOptions[$section]['bg_img']) && !empty(piThemeOptions::$piOptions[$section]['bg_img'])  ? piThemeOptions::$piOptions[$section]['bg_img']: '';
					if ( $getImage != '' )
					{
						if ( !preg_match("/http/", $getImage) )
						{
							if ( wp_attachment_is_image($getImage) )
							{
								$getImage = wp_get_attachment_url($getImage);
							}else{
								$getImage = "http://placehold.it/1600x1160";
							}
						}
					}else{
						$getImage = "http://placehold.it/1600x1160";
					}
					$overlay =  isset(piThemeOptions::$piOptions[$section]['overlay']) && !empty(piThemeOptions::$piOptions[$section]['overlay'])  ? piThemeOptions::$piOptions[$section]['overlay']: 0;

					$getColor =   isset(piThemeOptions::$piOptions[$section]['overlay_color']) && !empty(piThemeOptions::$piOptions[$section]['overlay_color'])  ? piThemeOptions::$piOptions[$section]['overlay_color']: 'rgba(0, 0, 0, 0.3)';
				}
			}
			

			if ( $bgType == 'none' )
			{
				$aReturn =  array('bg_type'=>'none');
			}elseif($bgType == 'image')
			{
				$aReturn =  array('bg_type'=>'image', 'src'=>$getImage, 'overlay'=>$overlay,'overlay_color'=>$getColor);
			}else{
				$aReturn =  array('bg_type'=>'color');
			}

			return json_encode($aReturn);
		}

		/*
		*--------------------------
			Check get data
		*--------------------------
		*/ 
		public function pi_get_data($section)
		{
			
			$getID     = isset(piThemeOptions::$piOptions[$section]['content']) && !empty(piThemeOptions::$piOptions[$section]['content']) ? piThemeOptions::$piOptions[$section]['content'] : false;
			

			return $getID;
		}

 		/*
		*--------------------------
			Check enable section
		*--------------------------
		*/
		public function pi_is_section_enable($section)
		{
			if ( has_action('customize_controls_init') ) return true;

			if ( isset(piThemeOptions::$piOptions[$section]['enable']) && !empty(piThemeOptions::$piOptions[$section]['enable']) )
			{
				return true;
			}else{
				return false;
			}
		}

		/*
		*--------------------------
			The heading
		*--------------------------
		*/
		public function pi_the_heading($section, $addClass="")
		{
			$title = "";

			if ( isset(piThemeOptions::$piOptions[$section]['title']) && !empty(piThemeOptions::$piOptions[$section]['title']) )
			{
				$title = piThemeOptions::$piOptions[$section]['title'];
			}
 
			if ( $title )
			{
				printf( __( ('<h3 class="h3 %s">%s</h3><hr class="he-divider">'), piCore::LANG), $addClass, wp_unslash($title) );
			}
		}

		/*
		*--------------------------
			The description
		*--------------------------
		*/
		public function pi_the_description($section, $addClass="")
		{
			$pidescription ="";

			if ( isset(piThemeOptions::$piOptions[$section]['description']) && !empty(piThemeOptions::$piOptions[$section]['description']) )
			{
				$pidescription = piThemeOptions::$piOptions[$section]['description'];
			}

			if ( $pidescription )
			{
				printf( __( ('<p class="sub-title %s">%s</p>'), piCore::LANG), $addClass, wp_unslash($pidescription) );	
			}
		}

		/*
		*--------------------------
			Get terms
		*--------------------------
		*/
		public static function pi_get_terms($taxName)
		{
			$piTerms = get_terms( $taxName);
			
			$aId = array();

			if ( !empty( $piTerms ) && !is_wp_error( $piTerms ) )
			{
				foreach ($piTerms as $data)
				{
					$aId[$data->name] = $data->term_id;
				}
			}

			return $aId;
		}

		public function pi_enqueue_scripts()
		{
			$piIsStaticPage = pi_is_static_page();
			
			$url = get_template_directory_uri() . '/assets/';
				
			
			wp_register_style('arvios_boostrap_plugin', $url . 'css/lib/bootstrap.min.css', array(), '3.0.2');
			wp_register_style('arvios_fa_plugin', get_template_directory_uri() . '/admin/pi-assets/css/font-awesome.min.css', array(), '4.0.2');
			wp_register_style('arvios_owl_carousel', $url . 'css/lib/owl.carousel.css', array(), '3.0.2');
			wp_register_style('arvios_stylesheet', $url .'css/stylesheet.css', array());
			wp_register_style('arvios_googlefont_raleway', '//fonts.googleapis.com/css?family=Raleway:400,600,700,900', array(), self::VERSION);
			wp_register_style('arvios_googlefont_arvo', '//fonts.googleapis.com/css?family=Arvo', array(), self::VERSION);
			wp_register_style('arvios_googlefont_opensans', '//fonts.googleapis.com/css?family=Open+Sans:400,300,600,700', array(), '1.0');
			wp_register_style('arvios_transitions', $url . 'css/lib/owl.transitions.css', array(), '0.9.9', true);
			wp_register_style('arvios_magnific_popup', $url .'css/lib/magnific-popup.css', array(), self::VERSION);
			wp_register_style('arvios_main_style', $url .'css/style.css', array(), self::VERSION);

		
			wp_enqueue_style('arvios_boostrap_plugin');
			wp_enqueue_style('arvios_stylesheet');
			wp_enqueue_style('arvios_fa_plugin');	
			wp_enqueue_style('arvios_owl_carousel');
			wp_enqueue_style('arvios_magnific_popup');
			wp_enqueue_script('arvios_transitions');
			wp_enqueue_style('arvios_googlefont_raleway');
			wp_enqueue_style('arvios_googlefont_arvo');
			wp_enqueue_style('arvios_googlefont_opensans');
			

			wp_enqueue_style('arvios_main_style');
			
			
				
			$min = SCRIPT_DEBUG ? '.' : '.min.'; 
			
				
			wp_register_script('arvios_blank', $url . 'js/localize.js', array(), '1.0');
			wp_register_script('arvios_twitter', $url . 'js/lib/tweetie.js', array(), '1.0', true);
			wp_register_script('arvios_bootstrap', $url . 'js/lib/bootstrap.min.js', array(), '3.0.2', true);
			wp_register_script('arvios_isotope', $url . 'js/lib/isotope.pkgd.min.js', array(), '1.0', true);
			wp_register_script('arvios_easing', $url . 'js/lib/jquery.easing.min.js', array(), '1.0', true);
			wp_register_script('arvios_ytplayer', $url . 'js/lib/jquery.mb.YTPlayer.js', array(), '1.0', true);
			wp_register_script('arvios_owl_carousel', $url . 'js/lib/jquery.owl.carousel.min.js', array(), '1.0', true);
			wp_register_script('arvios_parallax', $url . 'js/lib/jquery.parallax-1.1.3.min.js', array(), '1.0', true);
			wp_register_script('arvios_superslides', $url . 'js/lib/jquery.superslides.min.js', array(), '1.0', true);
			wp_register_script('arvios_wow', $url . 'js/lib/jquery.wow.min.js', array(), '1.2', true);
			wp_register_script('arvios_retina', $url . 'js/lib/retina.min.js', array(), '1.0', true);
			wp_register_script('arvios_smoothscroll', $url . 'js/lib/SmoothScroll.js', array(), '3.0.2', true);
			wp_register_script('arvios_magnific_popup', $url . 'js/lib/magnific-popup.js', array(), '0.9.9', true);
			
			wp_register_script('arvios_soundcloud', $url . 'js/lib/soundcloud.min.js', array(), '0.9.9', true);
			wp_register_script('arvios_scripts', $url . 'js/scripts.js', array(), '1.0', true);
			
			wp_enqueue_script('jquery');
			
			if ( $this->pi_is_ie9() )
			{
				wp_register_script('arvios_html5', $url . 'js/lib/html5.js', array(), '1.0');
				wp_register_script('arvios_css3-mediaqueries', $url . 'js/lib/css3-mediaqueries.js', array(), '1.0');
				wp_enqueue_script('arvios_html5'); 
				wp_enqueue_script('arvios_css3-mediaqueries');
			}
			
			wp_enqueue_script('arvios_blank'); 
			wp_enqueue_script('arvios_twitter'); 
			wp_enqueue_script('arvios_isotope'); 
			wp_enqueue_script('jquery-masonry'); 
			wp_enqueue_script('arvios_easing');
			wp_enqueue_script('arvios_ytplayer');
			wp_enqueue_script('arvios_owl_carousel');
			wp_enqueue_script('arvios_superslides');
			wp_enqueue_script('arvios_parallax');
			wp_enqueue_script('arvios_wow');
			wp_enqueue_script('arvios_retina');
			wp_enqueue_script('arvios_magnific_popup');
			wp_enqueue_script('arvios_soundcloud');
			wp_enqueue_script('arvios_smoothscroll');
			wp_enqueue_script('arvios_scripts');
			if( is_singular() ){
				wp_enqueue_script( "comment-reply" );
			} 
			
			wp_localize_script('arvios_scripts', 'WILOKE', array('ajaxurl'=>admin_url('admin-ajax.php')));


			$getSkin = isset(piThemeOptions::$piOptions['design']['color_scheme']) ? piThemeOptions::$piOptions['design']['color_scheme'] : 'default';
			
			$fileUrl = get_template_directory_uri() . '/assets/css/color/';

			if ( $getSkin == 'pi_use_custom_color' )
			{
				$getSkin = "custom";
				$uploads = wp_upload_dir();
				if ( file_exists($uploads['basedir'] . '/hercules/custom.css') )
				{
					$fileUrl = $uploads['baseurl'] . '/hercules/';
				}
			}else{
				$getSkin = trim($getSkin);
			}

			if ( $getSkin != 'default' )
			{
				wp_register_style('arvios_skin', $fileUrl . $getSkin . '.css', array(), '1.0');
				wp_enqueue_style('arvios_skin');
			}

		    $lat = isset(piThemeOptions::$piOptions['contact']['googlemap']['latitude']) && !empty(piThemeOptions::$piOptions['contact']['googlemap']['latitude']) ? piThemeOptions::$piOptions['contact']['googlemap']['latitude'] : '21.027764';
    		$long = isset(piThemeOptions::$piOptions['contact']['googlemap']['longitude']) && !empty(piThemeOptions::$piOptions['contact']['googlemap']['longitude']) ? piThemeOptions::$piOptions['contact']['googlemap']['longitude'] : '105.834160';

    		$googleMap = array('lat'=>$lat, 'long'=>$long);
    		$username  = isset(piThemeOptions::$piOptions['twitter']['username']) ?  piThemeOptions::$piOptions['twitter']['username']  : 'evanto';
    		$number    = isset(piThemeOptions::$piOptions['twitter']['number_of_tweets']) ?  piThemeOptions::$piOptions['twitter']['number_of_tweets']  : 5;

    		wp_localize_script('arvios_blank', 'WILOKE_GOOGLEMAP', $googleMap);

    		wp_localize_script('arvios_blank', 'piAjaxUrl', admin_url('admin-ajax.php'));

    		wp_localize_script('arvios_blank', 'piTwitterUsername', $username);

    		wp_localize_script('arvios_blank', 'piNumberOfTweets', $number);

    		if ( has_action('customize_preview_init') )
    		{
    			wp_localize_script('arvios_blank', 'PI_CONFIG', json_encode(self::$piaConfigs['sections']));
    		}
		}


		/*
		*----------------------------
			Deep slashes
		*----------------------------
		*/
		public function pi_unslashed_before_update($data)
        {   
            $data = is_array($data) ? array_map(array($this,'pi_unslashed_before_update'), $data) : wp_unslash($data);
        	return $data;
        }


		/*
		*----------------------------
			Mr.Ajax
		*----------------------------
		*/
		public function pi_ajax_machine()
		{
			include ( PI_ADMIN_MD . 'pi.mr-ajax.php' );
		}



		/*
		*----------------------------
			Admin scripts
		*----------------------------
		*/
		public function pi_admin_enqueue_scripts()
		{
			global $typenow;

			
			$piUrl = get_template_directory_uri() . '/admin/pi-assets/';

			

			wp_dequeue_script('autosave');
			wp_enqueue_script('jquery');

			wp_register_style('pi_switchery', $piUrl . 'css/switchery.min.css', array(), '1.0');
			wp_enqueue_style('pi_switchery');

			wp_register_style('pi_plugin_datepicker', $piUrl . 'css/jquery-ui-1.10.4.css', array(), '1.10.4');

			wp_register_style('pi_spectrum', $piUrl . 'css/spectrum.css', array(), '1.0');
			wp_enqueue_style('pi_spectrum');
			// wp_register_script('pi_add_video', $piUrl . 'js/pi.add_video.js', array(), self::VERSION, true);

			wp_register_script('pi_switch_checkbox', $piUrl . 'js/switchery.min.js', array(), self::VERSION, true);
			wp_enqueue_script('pi_switch_checkbox');

			wp_register_style('pi_form_style', $piUrl . 'css/pi.form-style.css', array(), '1.0');
			
			wp_enqueue_script('jquery-ui-datepicker');

			wp_register_script('pi_spectrum', $piUrl . 'js/spectrum.js', array(), '1.0');
			wp_enqueue_script('pi_spectrum');
			wp_enqueue_script('jquery-form');
			wp_enqueue_media();
			wp_enqueue_script('media-upload');
			wp_enqueue_style('thickbox');
			wp_enqueue_script('thickbox');


			wp_register_style('plugin_grid', $piUrl . 'css/grid.css', array(), self::VERSION);
			
			wp_enqueue_style('pi_popupstyle', $piUrl . 'css/pi.font-table.css', array(), self::VERSION); 
			wp_enqueue_style('pi_popupstyle');

			wp_enqueue_style('pi_tablefa', $piUrl . 'css/popup-style.css', array(), self::VERSION); 
			wp_enqueue_style('pi_tablefa');

			wp_register_script('pi_custom', $piUrl . 'js/pi.custom.js', array(), self::VERSION, true);
			wp_register_script('pi_blank', $piUrl . 'js/pi.blank.js', array(), self::VERSION, true);
			
			wp_register_script('pi_media_upload', $piUrl . 'js/pi.media_upload.js', array(), self::VERSION, true);

			wp_enqueue_script('pi_media_upload');	

			wp_enqueue_script('pi_blank');

			if ( $typenow != 'post' ) :
				wp_enqueue_style('plugin_grid');
				wp_enqueue_style('pi_form_style');
				wp_enqueue_style('pi_plugin_datepicker');
				wp_enqueue_script('pi_custom');
			endif;
		}


		public function pi_modules_init()
		{
			
			/*
			*---------------------------------
				Posts & Tax
			*---------------------------------
			*/
			$fileName = array("class.pi_post.php", "class.pi_avatar.php");

			foreach ($fileName as $file)
			{
				include (PI_ADMIN_MD . 'pi-taxonomy/' . $file);
			}
			

			/*=========================================*/
			/* Posts
			/*=========================================*/
			if ( $this->_piaEnableModules['posts'] == 1 ) :	
				$piPosts 		= new piPosts();
			endif;

			/*=========================================*/
			/*	Avatar
			/*=========================================*/
			if ( $this->_piaEnableModules['avatar'] == 1 ) :	
				$piAvatar 	= new piAvatar();
			endif;

			

			/*
			*---------------------------------
				Theme Options
			*---------------------------------
			*/
			include (PI_ADMIN_MD . 'pi-themeoptions/class.pi-themeoptions.php');
			$initThemeOptions = new piThemeOptions();


			/*
			*---------------------------------
				Import Demo data
			*--------------------------------- 
			*/
			include (PI_ADMIN_MD . 'pi-import-demo/class.pi-demo-builder.php');
			$initImportDemoMenu = new piImportDemoBuilder();

			/*
			*--------------------------------
				Register Sidebar
			*--------------------------------
			*/
			include (PI_ADMIN_MD . 'pi-sidebar/func.pi-registersidebar.php');

			/*
			*---------------------------------
				Menu Configs
			*---------------------------------
			*/
			include (PI_ADMIN_MD . 'pi-menu/class.pi_menuconfigs.php');
			$piMenuBoxes = new piMenuBoxes();

			/*
			*--------------------------------
				Update
			*--------------------------------
			*/
			include (PI_ADMIN_MD . 'pi-update/class.update.php');
			$piUpdapi = new piUpdate();

			/*
			*--------------------------------
				Widgets Builder
			*--------------------------------
			*/
			include (PI_ADMIN_MD . 'pi-widgets/class.widget-building.php');
			$piWidgets = new piWidgets();
		

			/*
			*-------------------------------
				Plugin Activation
			*-------------------------------
			*/
			include (PI_ADMIN_MD . 'pi-plugin-activation/class.pi-pluginactivation.php');
			$piPluginActiovation = new piPluginActiovation();

			/*
			*-------------------------------
				Shortcodes
			*-------------------------------
			*/
			// include (PI_ADMIN_MD . 'pi-shortcodes/class.pi-shortcodes.php');
			// $piShortcodes = new piShortcodes();

			/*
			*-------------------------------
				Filters
			*-------------------------------
			*/
			include (PI_ADMIN_MD . 'pi-filters/class.pi-filters.php');
			$piFilters = new piFilters();

			/*
			*-------------------------------
				Filters
			*-------------------------------
			*/
			include (PI_ADMIN_MD . 'pi-customize/class.customize.php');
			$piCustomize = new piCustomize();

		}

		/*Twitter*/
		public function pi_handle_tweet()
		{
		    // Consumer Key
		    $consumerKey 		= isset(piThemeOptions::$piOptions['twitter']['consumer_key']) ? piThemeOptions::$piOptions['twitter']['consumer_key']  : '';
		    $consumerSecret 	= isset(piThemeOptions::$piOptions['twitter']['consumer_secret']) ? piThemeOptions::$piOptions['twitter']['consumer_secret']  : '';
		    $accessToken 		= isset(piThemeOptions::$piOptions['twitter']['access_token']) ? piThemeOptions::$piOptions['twitter']['access_token']  : '';
		    $accessTokenSecret 	= isset(piThemeOptions::$piOptions['twitter']['access_token_secret']) ? piThemeOptions::$piOptions['twitter']['access_token_secret']  : '';

		    define('CONSUMER_KEY', $consumerKey);
		    define('CONSUMER_SECRET', $consumerSecret);

		    // User Access Token
		    define('ACCESS_TOKEN', $accessToken);
		    define('ACCESS_SECRET', $accessTokenSecret);
			include ( 'pi-modules/pi-libs/twitter/tweet.php' );
			die;
		}

	}

	// pi_configs.php
	$piInit = new piCore($piaConfigs);
}else{
	wp_die("Sorry! It has been confligs class name");
}